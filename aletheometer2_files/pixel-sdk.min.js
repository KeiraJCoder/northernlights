!function(a){"use strict";a.PIXEL_SDK_ENVIRONMENT="production";var E,n,e,o,r,s,t={ENVIRONMENT:a.PIXEL_SDK_ENVIRONMENT||"development",PIXEL_SERVICE_URL:{development:"//dev-pixel.ex.co",staging:"//stg-pixel.ex.co",production:"//pixel.ex.co"},PIXEL_SERVICE_METHOD_ITEM:"/v1/item/",PIXEL_SERVICE_METHOD_STREAM:"/v1/stream/",PIXEL_SERVICE_METHOD_BRANDED_ELEMENT:"/v1/branded-element/",PIXEL_SERVICE_METHOD_CAMPAIGN:"/v1/campaign/",PIXEL_SERVICE_METHOD_PLAYBUZZ:"/v1/playbuzz/",PIXEL_SERVICE_METHOD_PLAYBUZZ_NETWORK:"/v1/playbuzz-network/",EVENT_NAMES:{item:"pbItemEvent",stream:"pbStreamEvent",brandedElement:"pbBrandedElementEvent",playbuzz:"pbEvent"},PB_KINESIS:{staging:"https://stg-collector-platform.ex.co/main/events",development:"https://stg-collector-platform.ex.co/main/events",production:"https://prd-collector-platform.ex.co/main/events"},ITEM_ID:(a.pbItem?a.pbItem.id:"")||(a.gameData?a.gameData.gameId:""),PLACEMENT_ID:a.placementId,PAGE_LOAD_UID:a.plbzPid||a.pbPageIdentifier||"",PRELOADED_PIXELS_DATA:a.preloadedPixelsData||null},i=(E="display:none !important;",{inject:function(t,e){e=e||{};var i,n,a,o,r,s,c,d=(i=document.createElement(t),(n=e).id&&i.setAttribute("id",n.id),n.className&&i.setAttribute("class",n.className),i.setAttribute("style",E),i);e.parentId&&e.content?(document.getElementById(e.parentId).appendChild(d),"iframe"===t?(d.contentDocument.open(),d.contentDocument.write("<html><body>"+e.content+"</body></html>"),d.contentDocument.close()):d.appendChild((a=e.content,o=/<script[\s\S]*?>[\s\S]*?<\/script>/gi,r=document.createDocumentFragment(),s=a.match(o),(c=document.createElement("TEMPLATE")).innerHTML=a.replace(o,""),r.appendChild(c.content),s&&s.forEach(function(t){var e,i=document.createElement("SCRIPT"),n=t.replace(/<script[\s\S]*?>/gi,"").replace(/<\/script>/gi,"").replace(/\n/gi,"");e=i,function(t){var e=document.createElement("div");e.innerHTML=t;var i,n=e.firstChild,a=[];if(n.attributes)for(i=0;i<n.attributes.length;i++)a.push(n.attributes[i]);else if(n.getAttributeNames){var o=n.getAttributeNames();for(i=0;i<o.length;i++)a.push({name:o[i],value:n.getAttribute(o[i])})}return a}(t).forEach(function(t){t.name&&t.value&&e.setAttribute(t.name,t.value)}),i.appendChild(document.createTextNode(n)),r.appendChild(i)}),r))):document.body.appendChild(d)},dispatchEvent:function(t,e){var i=document.createEvent("CustomEvent");i.initCustomEvent(t,!1,!1,e),document.body.dispatchEvent(i)},listen:function(t,e){document.body.addEventListener(t,e)}}),c=function(){function o(t,e,i,n,a){var o=new XMLHttpRequest;return o.open(t,e,!0),o.onreadystatechange=function(){var t,e;e=n,4!==(t=o).readyState||200!==t.status&&(e&&e(),1)||i&&i(o.response)},o}return{get:function(t,e,i){new o("GET",t,e,i).send()},post:function(t,e,i,n){var a=new o("POST",t,i,n);a.setRequestHeader("Content-Type","application/json;"),a.send(e?JSON.stringify(e):null)}}}(),d=(n=c,o=(e=t).PB_KINESIS[e.ENVIRONMENT],r=(new Date).getTime(),s=function(){var t={articleId:e.ITEM_ID||null,pageLoadUid:e.PAGE_LOAD_UID};e.PLACEMENT_ID&&(t.placementId=e.PLACEMENT_ID,t.experienceId=t.articleId);return t}(),{send:function(t,e){var i={};i.deltaTime=(((new Date).getTime()-r)/1e3).toFixed(2),i.eventName=t,i=function(){for(var t={},e=0;e<arguments.length;e++){var i=arguments[e];for(var n in i)t[n]=i[n]}return t}(e,i,s),n.post(o,i)}}),l=function(t,e,i){this.events=i,this.data=t,this.dom=e,this.className="sdk-pixel",this.pixelSdkEventName="pixelSdkEvent",this.fired=!1,this.macros={"{cb}":function(){return(new Date).getTime()}},"story.engagement"===this.data.event.type&&this.createDelayedPixel()};function p(t,e,i,n,a,o){this.events=o,this.http=t,this.configs=e,this.Pixel=i,this.dom=n,this.itemId=a,this.pixelsContainerId="pixel-sdk-container",this.pixels=[],this.serviceUri=this.configs.PIXEL_SERVICE_URL[this.configs.ENVIRONMENT]}function m(t,e){f(this,e,h(JSON.parse(t),this))}function u(t){}function h(t,e){for(var i,n,a,o=e,r=[],s=0;s<t.length;s++){var c=t[s];c.html=decodeURIComponent(c.html),r.push((i=c,a=void 0,(a=new(n=o).Pixel(i,n.dom,n.events)).init(),n.pixels.push(a),a))}return r}function f(t,e,i){var n=t;e||(e=n.configs.EVENT_NAMES.item),n.dom.listen(e,function(e){i.forEach(function(t){t.matchAndInject(e)})})}l.prototype.createDelayedPixel=function(){var t=this;setTimeout(function(){t.fired||(t.fired=!0,t.injectDelayed())},this.data.event.delay)},l.prototype.replaceMacros=function(t){t=t||"";for(var e in this.macros)-1<t.indexOf(e)&&(t="function"==typeof this.macros[e]?t.replace(e,this.macros[e]()):t.replace(e,this.macros[e]));return t},l.prototype.init=function(){var t=!0,e=!1;this.data.targeting&&(t=this.matchURL(this.data.targeting),e=this.isBSExcluded(this.data.targeting)),!this.data.event.data&&"story.engagement"!==this.data.event.type&&t&&!1===e&&this.inject()},l.prototype.matchAndInject=function(t){var e=this,i=e.matchName(t.detail.name,e.data.event),n=e.matchData(t.detail.data,e.data.event.data),a=e.matchURL(e.data.targeting||{}),o=e.isBSExcluded(e.data.targeting||{});i&&n&&a&&!1===o&&(e.data.event.fireOnce&&!e.fired?(e.fired=!0,e.inject()):e.data.event.fireOnce||e.inject())},l.prototype.isBSExcluded=function(t){if(t.excludeBS){var e=a.parent,i=e.pbItem&&e.pbItem.sponsored&&e.pbItem.sponsored.enabled,n=e.gameData&&"True"===e.gameData.isBranded;return e===a.top&&(n||i)}return!1},l.prototype.matchData=function(t,e){var i=Object.assign({},t),n=!0;for(var a in e&&void 0===e.itemActionId&&delete i.itemActionId,e)void 0!==i[a]&&i[a]===e[a]||(n=!1);return n},l.prototype.matchName=function(t,e){return"story.engagement"===e.type?-1!==e.names.indexOf(t):t===e.name},l.prototype.matchURL=function(t){var e=parent!==a?document.referrer:a.location.href,i=!0;return t.urls&&t.urls.length&&("include"===t.mode?(i=!1,t.urls.forEach(function(t){i=i||-1!==e.indexOf(t)})):"exclude"===t.mode&&(i=!0,t.urls.forEach(function(t){i=i&&-1===e.indexOf(t)}))),i},l.prototype.notify=function(t,e){this.events.send("pixel_injected",{pixelId:this.data.id}),this.dom.dispatchEvent(this.pixelSdkEventName,{name:t,data:e})},l.prototype.sendEvent=function(){},l.prototype.injectDelayed=function(){this.inject(!0)},l.prototype.inject=function(t){this.data.html=this.replaceMacros(this.data.html),this.dom.inject("noIFrame"===this.data.mode?"div":"iframe",{id:this.data.id,className:this.className,content:t?this.data.htmlDelayed:this.data.html,parentId:"pixel-sdk-container"}),this.notify("pixel-sdk.pixel.injected",this.data)},p.prototype.init=function(){this.dom.inject("div",{id:this.pixelsContainerId})},p.prototype.initPreloadedPixels=function(){this.configs.PRELOADED_PIXELS_DATA&&f(this,null,h(this.configs.PRELOADED_PIXELS_DATA,this))},p.prototype.initItem=function(){if(this.itemId){var e=this,t=this.serviceUri+this.configs.PIXEL_SERVICE_METHOD_ITEM+this.itemId;this.http.get(t,function(t){m.call(e,t,e.configs.EVENT_NAMES.item)},u)}},p.prototype.initBrandedElement=function(t,e){var i=this;if(t){var n=this.serviceUri+this.configs.PIXEL_SERVICE_METHOD_BRANDED_ELEMENT+t;this.http.get(n,function(t){m.call(i,t,i.configs.EVENT_NAMES.brandedElement)},u)}if(e){var a=this.serviceUri+this.configs.PIXEL_SERVICE_METHOD_CAMPAIGN+e;this.http.get(a,function(t){m.call(i,t,i.configs.EVENT_NAMES.brandedElement)},u)}},p.prototype.initStream=function(t){if(t){var e=this,i=this.serviceUri+this.configs.PIXEL_SERVICE_METHOD_STREAM+t;this.http.get(i,function(t){m.call(e,t,e.configs.EVENT_NAMES.stream)},u)}},p.prototype.initPlaybuzz=function(){var e=this,t=this.serviceUri+this.configs.PIXEL_SERVICE_METHOD_PLAYBUZZ;this.http.get(t,function(t){m.call(e,t,e.configs.EVENT_NAMES.playbuzz)},u)},p.prototype.initPlaybuzzNetwork=function(){var e=this,t=this.serviceUri+this.configs.PIXEL_SERVICE_METHOD_PLAYBUZZ_NETWORK;this.http.get(t,function(t){m.call(e,t,e.configs.EVENT_NAMES.item)},u)};var v,I=new p(c,t,l,i,t.ITEM_ID,d);a.pbPixelSDK||(a.preloadedPixelsData?(I.init(),I.initPreloadedPixels()):setTimeout(function(){I.init(),I.initItem()})),(v=a.document.querySelectorAll(".new-item-stats")[0])||(v=a.document.querySelectorAll(".embed-stat")[0]),(v?"false"!==v.getAttribute("is-embed"):(v=a.document.getElementById("app"))&&"true"===v.getAttribute("data-embed"))&&I.initPlaybuzzNetwork(),a.pbPixelSDK=I}(window);